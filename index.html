<!doctype html>
<html>
  <head>
    <title>HARDLY PONDERED | CODERS++</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
    </style>
  </head>
  <body>
    <h1></h1>
    <div id="u">Player ID: <span id="user"></span></div>
    <div id="x"></div>
    <h1 id="pen"></h1>
    <!--<button onPress="connectMe()">Connect</button>-->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var currTime;
        var socket;    
        document.addEventListener('DOMContentLoaded', init, true);
        function init() {
            socket = io.connect();
            socket.on('newUser', function(msg) {
                if (sessionStorage) {
                    sessionStorage.setItem("user", msg)
                }
                localStorage.setItem("user", msg)
                document.getElementById('user').innerHTML = sessionStorage.getItem("user")
                //alert("Welcome " + sessionStorage.getItem("user"))
            })
            socket.emit('connectMe')
            socket.on('message', function(msg) {
                document.getElementById('pen').innerHTML = 'PENCHO'
            }) 
            currTime = new Date()
            currTime = currTime.getTime()
            console.log('Engage');
            window.addEventListener('devicemotion', motion, false);
        }
        
        function connectMe() {
            socket.emit('connectMe')
        }

        let lastX, lastY, lastZ;

        function motion(e) {
            var state = false;
            //socket.emit('spells', 'vasu')
            let acc = e.acceleration;
            let t = new Date();
            let time = t.getTime();
            
            //alert(t.getTime())
            if(!acc.x) return;

            //only log if x,y,z > 1
            //console.log('motion', acc);
            if(!lastX) {
                lastX = acc.x;
                lastY = acc.y;
                lastZ = acc.z;
                return ;
            }

            let deltaX = Math.abs(acc.x - lastX);
            let deltaY = Math.abs(acc.y - lastY);
            let deltaZ = Math.abs(acc.z - lastZ);
            document.getElementById('x').innerHTML = acc.x
            
            if(deltaX < 2) {
                deltaX = 0;
            } 
            if (deltaY < 2) {
                deltaY = 0;
            }
            if (deltaZ < 2) {
                deltaZ = 0;
            }
            socket.emit('spells', time - currTime)
            ///console.log(time, currTime)
            if (time - currTime > 400 && state != false) {
                //alert('Vasu')
                taskAtHand = false
                socket.emit('spells', 'vasu')
                if (acc.x > 10) {
                    r = 200;
                    document.getElementById('a').innerHTML = 'I did something'
                    //socket.emit('chat message', 'UP')
                    socket.emit('spells', {'spell': 'UP', 'user': sessionStorage.getItem('user')})
                    taskAtHand = 'UP'
                    currTime = time
                    state = true
                }
                if (acc.y > 2) {
                    g = 200;
                    currTime = time
                    //socket.emit('chat message', 'FORWARD')
                    socket.emit('spells', {'spell': 'FORWARD', 'user': sessionStorage.getItem('user')})
                    taskAtHand = 'FORWARD'
                    state = true
                }
                if (acc.z > 10) {
                    r = 200;
                    currTime = time
                    //socket.emit('chat message', 'SIDE')
                    socket.emit('spells', {'spell': 'SIDE', 'user': sessionStorage.getItem('user')})
                    taskAtHand = 'SIDE'
                    state = true
                }
            }


            if (time - currTime > 1000 && state != false) {
                socket.emit('chat message', 'back to normal')
                document.getElementById('pen').innerHTML = 'HATT'
                state = false
            }

            lastX = acc.x;
            lastY = acc.y;
            lastZ = acc.z;
        }
    </script>
  </body>
</html>